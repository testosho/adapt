<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Screenplay Adaptation Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom scrollbar and editor styling for a professional feel */
        textarea, .editor-panel {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        textarea:focus, input:focus {
            outline: none;
            box-shadow: none;
            border-color: #4a90e2;
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen">

    <!-- =========== SETUP VIEW =========== -->
    <div id="setup-view" class="flex items-center justify-center h-full">
        <div class="max-w-2xl w-full bg-gray-800 p-8 rounded-2xl shadow-2xl space-y-6">
            <header class="text-center">
                <h1 class="text-3xl font-bold text-blue-400">Screenplay Adaptation Studio</h1>
                <p class="text-gray-400 mt-2">Transform your script for any language, culture, or setting.</p>
            </header>

            <!-- API Selection -->
            <div>
                <h2 class="font-semibold mb-3 text-lg">1. Choose Your AI Engine</h2>
                <div class="grid grid-cols-2 gap-4">
                    <label class="bg-gray-700 p-4 rounded-lg cursor-pointer border-2 border-transparent has-[:checked]:border-blue-500 has-[:checked]:bg-gray-900 transition-all">
                        <input type="radio" name="apiSelection" value="gemini" class="hidden" checked>
                        <h3 class="font-bold text-white">Gemini API (Cloud)</h3>
                        <p class="text-xs text-gray-400 mt-1">High-quality models from Google. Requires an API key.</p>
                    </label>
                    <label class="bg-gray-700 p-4 rounded-lg cursor-pointer border-2 border-transparent has-[:checked]:border-blue-500 has-[:checked]:bg-gray-900 transition-all">
                        <input type="radio" name="apiSelection" value="local" class="hidden">
                        <h3 class="font-bold text-white">Local Server (e.g., LM Studio)</h3>
                        <p class="text-xs text-gray-400 mt-1">Private, offline processing. Requires a local server to be running.</p>
                    </label>
                </div>
            </div>

            <!-- API Configuration -->
            <div id="api-config-forms">
                <div id="gemini-form" class="space-y-2">
                    <label for="apiKey" class="text-sm font-medium text-gray-300">Gemini API Key</label>
                    <input type="password" id="apiKey" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-sm" placeholder="Enter your Google AI Studio API Key">
                </div>
                <div id="local-form" class="hidden space-y-2">
                    <label for="apiUrl" class="text-sm font-medium text-gray-300">Local Server URL</label>
                    <input type="text" id="apiUrl" value="http://localhost:1234/v1/chat/completions" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-sm">
                </div>
            </div>

             <!-- Screenplay Upload -->
             <div>
                <h2 class="font-semibold mb-3 text-lg">2. Upload Your Screenplay</h2>
                <input type="file" id="fileInput" accept=".pdf,.docx,.fountain,.txt" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                <p id="fileStatus" class="text-xs text-gray-400 mt-2">Upload a PDF, DOCX, or Fountain file.</p>
            </div>

            <button id="viewScriptButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 flex items-center justify-center text-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                Load & Enter Studio
            </button>
        </div>
    </div>

    <!-- =========== EDITOR VIEW =========== -->
    <div id="editor-view" class="hidden flex h-screen">
        <!-- Left Panel: Controls -->
        <div class="w-1/4 bg-gray-800 p-6 flex flex-col h-full">
            <h2 class="text-xl font-bold text-blue-400 border-b border-gray-600 pb-3 mb-4">Adaptation Controls</h2>
            <div class="space-y-4 overflow-y-auto flex-grow">
                <div>
                    <label for="targetLanguage" class="text-sm font-medium text-gray-300">Target Language</label>
                    <input type="text" id="targetLanguage" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 mt-1 text-sm" placeholder="e.g., Japanese">
                </div>
                <div>
                    <label for="targetCulture" class="text-sm font-medium text-gray-300">Target Culture / Nation</label>
                    <input type="text" id="targetCulture" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 mt-1 text-sm" placeholder="e.g., Modern-day Tokyo">
                </div>
                <div>
                    <label for="manualChanges" class="text-sm font-medium text-gray-300">Core Instructions & Changes</label>
                    <textarea id="manualChanges" rows="5" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 mt-1 text-sm" placeholder="e.g., Change protagonist to a software engineer. Make the tone more comedic."></textarea>
                </div>
            </div>
             <p id="appStatus" class="text-sm text-yellow-400 text-center my-4 h-8"></p>
            <div class="space-y-3 pt-4 border-t border-gray-600">
                 <button id="continueButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-center space-x-2">
                     <span id="continueText">Generate Next Part</span>
                     <div id="continueLoader" class="loader hidden"></div>
                </button>
                <button id="downloadButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Download Adapted Script</button>
                <button id="resetButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Start Over</button>
            </div>
        </div>

        <!-- Middle Panel: Original Script -->
        <div class="w-3/8 bg-gray-800 border-l border-r border-gray-700 flex flex-col">
            <h3 class="text-lg font-semibold p-4 border-b border-gray-700 bg-gray-900">Original Script</h3>
            <textarea id="originalScriptViewer" class="editor-panel w-full h-full bg-gray-800 p-4 text-gray-300 font-mono text-sm leading-relaxed resize-none" readonly>Original script will be displayed here...</textarea>
        </div>

        <!-- Right Panel: Adapted Script (Editable) -->
        <div class="w-3/8 flex flex-col">
            <h3 class="text-lg font-semibold p-4 border-b border-gray-700 bg-gray-900">Adapted Script (Editable)</h3>
            <textarea id="adaptedScriptEditor" class="editor-panel w-full h-full bg-black p-4 text-white font-mono text-sm leading-relaxed resize-none" placeholder="AI-generated adaptation will appear here. You can edit this text at any time."></textarea>
        </div>
    </div>

    <script>
        // DOM Elements
        const setupView = document.getElementById('setup-view');
        const editorView = document.getElementById('editor-view');
        const apiSelectionRadios = document.querySelectorAll('input[name="apiSelection"]');
        const geminiForm = document.getElementById('gemini-form');
        const localForm = document.getElementById('local-form');
        const fileInput = document.getElementById('fileInput');
        const fileStatus = document.getElementById('fileStatus');
        const viewScriptButton = document.getElementById('viewScriptButton');
        const continueButton = document.getElementById('continueButton');
        const continueText = document.getElementById('continueText');
        const continueLoader = document.getElementById('continueLoader');
        const originalScriptViewer = document.getElementById('originalScriptViewer');
        const adaptedScriptEditor = document.getElementById('adaptedScriptEditor');
        const appStatus = document.getElementById('appStatus');
        const downloadButton = document.getElementById('downloadButton');
        const resetButton = document.getElementById('resetButton');

        // State variables
        let originalScriptContent = '';
        let currentChunkIndex = 0;
        const CHUNK_SIZE = 7000;

        // --- Event Listeners ---
        apiSelectionRadios.forEach(radio => radio.addEventListener('change', toggleApiForm));
        fileInput.addEventListener('change', handleFileUpload);
        viewScriptButton.addEventListener('click', showEditorView);
        continueButton.addEventListener('click', generateNextPart);
        resetButton.addEventListener('click', () => window.location.reload());
        downloadButton.addEventListener('click', downloadScript);
        [originalScriptViewer, adaptedScriptEditor].forEach(el => el.addEventListener('scroll', syncScroll));

        // --- Core Logic ---
        function toggleApiForm(event) {
            if (event.target.value === 'gemini') {
                geminiForm.classList.remove('hidden');
                localForm.classList.add('hidden');
            } else {
                geminiForm.classList.add('hidden');
                localForm.classList.remove('hidden');
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            viewScriptButton.disabled = true;
            fileStatus.textContent = `Parsing "${file.name}"...`;
            fileStatus.classList.remove('text-green-500', 'text-red-500');

            try {
                const extension = file.name.split('.').pop().toLowerCase();
                let textContent = '';
                if (extension === 'pdf') textContent = await parsePdf(file);
                else if (extension === 'docx') textContent = await parseDocx(file);
                else if (['fountain', 'txt'].includes(extension)) textContent = await file.text();
                else throw new Error('Unsupported file type.');
                
                originalScriptContent = textContent;
                fileStatus.textContent = `✅ Loaded: ${file.name}`;
                fileStatus.classList.add('text-green-500');
                viewScriptButton.disabled = false;
            } catch (error) {
                fileStatus.textContent = `Error: ${error.message}`;
                fileStatus.classList.add('text-red-500');
            }
        }

        function showEditorView() {
            if (!originalScriptContent) return;
            originalScriptViewer.value = originalScriptContent;
            setupView.classList.add('hidden');
            editorView.classList.remove('hidden');
            updateStatus('Ready. Enter parameters and generate the first part.', 'green');
        }

        async function generateNextPart() {
            setContinueButtonLoading(true);

            const startIndex = currentChunkIndex * CHUNK_SIZE;
            if (startIndex >= originalScriptContent.length) {
                updateStatus('Adaptation complete!', 'green');
                setContinueButtonLoading(false, true);
                return;
            }
            
            const scriptChunk = originalScriptContent.substring(startIndex, startIndex + CHUNK_SIZE);
            const progress = Math.round((startIndex / originalScriptContent.length) * 100);
            updateStatus(`Adapting part ${currentChunkIndex + 1}... (${progress}%)`, 'yellow');

            const systemPrompt = `You are a world-class screenplay adapter. Your task is to adapt a screenplay to a new language, culture, and setting. You will receive the original screenplay in parts. Maintain consistency with character names, plot points, and tone across all parts. This is a continuous task. Build upon the previous parts to create a cohesive, full-length adapted script.`;
            
            let userPrompt = `Adapt the following screenplay chunk based on these parameters:\n- Target Language: ${document.getElementById('targetLanguage').value || 'as in original'}\n- Target Culture/Nation: ${document.getElementById('targetCulture').value || 'as in original'}\n- Core Instructions: ${document.getElementById('manualChanges').value || 'None'}\n\n---\n`;
            
            if (adaptedScriptEditor.value.length > 0) {
                const context = adaptedScriptEditor.value.slice(-500);
                userPrompt += `CONTEXT from the end of your last adapted part (DO NOT REPEAT THIS):\n"...${context}"\n\n---\n`;
            }

            userPrompt += `ORIGINAL SCRIPT CHUNK (Part ${currentChunkIndex + 1}):\n"${scriptChunk}"\n\n---\nPlease provide ONLY the adapted version of THIS CHUNK. Do not add introductory phrases like "Here is the adapted chunk".`;

            try {
                const result = await callApi(systemPrompt, userPrompt);
                adaptedScriptEditor.value += (adaptedScriptEditor.value.length > 0 ? '\n\n' : '') + result;
                adaptedScriptEditor.scrollTop = adaptedScriptEditor.scrollHeight; // Auto-scroll
                currentChunkIndex++;
                
                const isFinished = currentChunkIndex * CHUNK_SIZE >= originalScriptContent.length;
                updateStatus(isFinished ? 'Adaptation complete!' : `Part ${currentChunkIndex} finished. Ready for next.`, 'green');
                setContinueButtonLoading(false, isFinished);

            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'red');
                setContinueButtonLoading(false);
            }
        }

        async function callApi(systemPrompt, userPrompt) {
            const selectedApi = document.querySelector('input[name="apiSelection"]:checked').value;
            
            if (selectedApi === 'gemini') {
                const apiKey = document.getElementById('apiKey').value;
                if (!apiKey) throw new Error('Gemini API Key is missing.');
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { temperature: 0.7, maxOutputTokens: 8192 },
                };
                 const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 if (!response.ok) { const err = await response.json(); throw new Error(`API Error: ${err.error.message}`); }
                 const result = await response.json();
                 return result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';

            } else { // local
                const url = document.getElementById('apiUrl').value;
                if (!url) throw new Error('Local Server URL is missing.');
                 const payload = {
                    model: "local-model",
                    messages: [ { "role": "system", "content": systemPrompt }, { "role": "user", "content": userPrompt } ],
                    temperature: 0.7, max_tokens: -1, stream: false
                };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const err = await response.json(); throw new Error(`API Error: ${err.error?.message || 'Request failed'}`); }
                const result = await response.json();
                return result.choices?.[0]?.message?.content?.trim() || '';
            }
        }

        // --- UI and Helper Functions ---
        function setContinueButtonLoading(isLoading, isFinished = false) {
            continueButton.disabled = isLoading || isFinished;
            if (isFinished) {
                continueText.textContent = 'Finished';
                continueButton.classList.replace('bg-blue-600', 'bg-gray-500');
            } else if (isLoading) {
                continueText.classList.add('hidden');
                continueLoader.classList.remove('hidden');
            } else {
                continueText.textContent = 'Generate Next Part';
                continueText.classList.remove('hidden');
                continueLoader.classList.add('hidden');
            }
        }

        function updateStatus(message, color) {
            const colorClass = { green: 'text-green-400', yellow: 'text-yellow-400', red: 'text-red-400' };
            appStatus.textContent = message;
            appStatus.className = `text-sm text-center my-4 h-8 ${colorClass[color] || 'text-gray-400'}`;
        }
        
        function downloadScript() {
            const text = adaptedScriptEditor.value;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'adapted_screenplay.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        let scrollTimeout;
        function syncScroll(event) {
            clearTimeout(scrollTimeout);
            const sourceElement = event.target;
            const targetElement = sourceElement.id === 'originalScriptViewer' ? adaptedScriptEditor : originalScriptViewer;
            
            const scrollPercentage = sourceElement.scrollTop / (sourceElement.scrollHeight - sourceElement.clientHeight);
            targetElement.scrollTop = scrollPercentage * (targetElement.scrollHeight - targetElement.clientHeight);

            // Temporarily remove the listener from the target to prevent feedback loops
            targetElement.removeEventListener('scroll', syncScroll);
            scrollTimeout = setTimeout(() => {
                targetElement.addEventListener('scroll', syncScroll);
            }, 100); // Debounce
        }

        // --- File Parsers ---
        async function parsePdf(file) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
            const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            return text;
        }

        async function parseDocx(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }
    </script>
</body>
</html>

