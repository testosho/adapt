<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Screenplay Adaptation Studio - LM Studio Integration</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
<style>
  @import url('https://rsms.me/inter/inter.css');
  body { font-family: 'Inter', sans-serif; }
  .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  textarea, .editor-panel { scrollbar-width: thin; scrollbar-color: #4a5568 #2d3748; }
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: #2d3748; }
  ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #718096; }
  textarea:focus, input:focus { outline: none; box-shadow: none; border-color: #4a90e2; }
</style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen">

<!-- SETUP VIEW -->
<div id="setup-view" class="flex items-center justify-center h-full p-6">
  <div class="max-w-3xl w-full bg-gray-800 p-8 rounded-2xl shadow-2xl space-y-6 overflow-y-auto max-h-[90vh]">
    <header class="text-center">
      <h1 class="text-3xl font-bold text-blue-400">Screenplay Adaptation Studio</h1>
      <p class="text-gray-400 mt-2">Transform your script for any language, culture, or setting with AI-guided hierarchical writing workflow.</p>
    </header>

    <!-- API Selection -->
    <section>
      <h2 class="font-semibold mb-3 text-lg">1. Choose Your AI Engine</h2>
      <div class="grid grid-cols-2 gap-4">
        <label class="bg-gray-700 p-4 rounded-lg cursor-pointer border-2 border-transparent has-[:checked]:border-blue-500 has-[:checked]:bg-gray-900 transition-all">
          <input type="radio" name="apiSelection" value="gemini" class="hidden" checked>
          <h3 class="font-bold text-white">Gemini API (Cloud)</h3>
          <p class="text-xs text-gray-400 mt-1">High-quality models from Google. Requires an API key.</p>
        </label>
        <label class="bg-gray-700 p-4 rounded-lg cursor-pointer border-2 border-transparent has-[:checked]:border-blue-500 has-[:checked]:bg-gray-900 transition-all">
          <input type="radio" name="apiSelection" value="local" class="hidden">
          <h3 class="font-bold text-white">Local Server (e.g., LM Studio)</h3>
          <p class="text-xs text-gray-400 mt-1">Private, offline processing. Requires a local server to be running.</p>
        </label>
      </div>
    </section>

    <!-- API Configuration -->
    <section id="api-config-forms">
      <div id="gemini-form" class="space-y-2">
        <label for="apiKey" class="text-sm font-medium text-gray-300">Gemini API Key</label>
        <input type="password" id="apiKey" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-sm" placeholder="Enter your Google AI Studio API Key" />
      </div>
      <div id="local-form" class="hidden space-y-2">
        <label for="apiUrl" class="text-sm font-medium text-gray-300">Local Server URL</label>
        <input type="text" id="apiUrl" value="http://localhost:1234" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-sm" />
        <p class="text-xs text-gray-400 mt-1">Do not include path. Only base URL (e.g. http://localhost:1234)</p>
      </div>
    </section>

    <!-- Screenplay Upload -->
    <section>
      <h2 class="font-semibold mb-3 text-lg">2. Upload Your Screenplay</h2>
      <input type="file" id="fileInput" accept=".pdf,.docx,.fountain,.txt" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600" />
      <p id="fileStatus" class="text-xs text-gray-400 mt-2">Upload a PDF, DOCX, Fountain, or Plain Text file.</p>
    </section>

    <!-- Beat Sheet / Outline Upload or type -->
    <section>
      <h2 class="font-semibold mb-3 text-lg">3. Define Screenplay Structure (Beat Sheet)</h2>
      <textarea id="beatSheetInput" rows="5" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-sm text-gray-400 placeholder-gray-500" placeholder="Paste or type your story beats (e.g., Act 1: Setup, Act 2: Conflict, etc.)"></textarea>
      <p class="text-xs text-gray-500 mt-1">Optional but recommended for better chunking and coherence.</p>
    </section>

    <button id="viewScriptButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 flex items-center justify-center text-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Load & Enter Studio</button>

    <button id="testLocalApiButton" class="mt-4 w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-center text-lg">
      Test Local API Connection
    </button>
    <p id="apiTestStatus" class="text-xs mt-2 text-center"></p>

  </div>
</div>

<!-- EDITOR VIEW -->
<div id="editor-view" class="hidden flex h-screen overflow-hidden">
  <!-- Left Panel: Controls and Story Memory -->
  <div class="w-1/4 bg-gray-800 p-6 flex flex-col h-full overflow-auto">
    <h2 class="text-xl font-bold text-blue-400 border-b border-gray-600 pb-3 mb-4">Adaptation Controls & Story Memory</h2>

    <div class="space-y-4">
      <label for="targetLanguage" class="text-sm font-medium text-gray-300">Target Language</label>
      <input type="text" id="targetLanguage" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-sm" placeholder="e.g., Japanese" />

      <label for="targetCulture" class="text-sm font-medium text-gray-300">Target Culture / Nation</label>
      <input type="text" id="targetCulture" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-sm" placeholder="e.g., Modern-day Tokyo" />

      <label for="manualChanges" class="text-sm font-medium text-gray-300">Core Instructions & Changes</label>
      <textarea id="manualChanges" rows="5" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-sm" placeholder="e.g., Change protagonist to a software engineer. Make the tone more comedic."></textarea>

      <label class="text-sm font-medium text-gray-300 mt-4">Story Memory (Characters, Plot Points, Themes)</label>
      <textarea id="storyMemory" rows="8" readonly class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-sm text-gray-400 overflow-auto"></textarea>
    </div>

    <p id="appStatus" class="text-center text-yellow-400 my-4 h-8"></p>

    <div class="space-y-3 pt-4 border-t border-gray-600">
      <button id="continueButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center space-x-2">
        <span id="continueText">Generate Next Part</span>
        <div id="continueLoader" class="loader hidden"></div>
      </button>
      <button id="downloadButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Download Adapted Script</button>
      <button id="resetButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Start Over</button>
    </div>
  </div>

  <!-- Middle Panel: Original Script -->
  <div id="original-script-panel" style="flex-basis: 50%;" class="bg-gray-800 border-l border-r border-gray-700 flex flex-col overflow-auto">
    <h3 class="text-lg font-semibold p-4 border-b border-gray-700 bg-gray-900 flex-shrink-0">Original Script</h3>
    <textarea id="originalScriptViewer" class="editor-panel w-full h-full bg-gray-800 p-4 text-gray-300 font-mono text-sm leading-relaxed resize-none" readonly>Original script will be displayed here...</textarea>
</div>

<div id="resizer" class="w-2 bg-gray-700 cursor-col-resize flex-shrink-0 hover:bg-blue-600 active:bg-blue-500 transition-colors"></div>

<div id="adapted-script-panel" style="flex-basis: 50%;" class="flex flex-col overflow-auto">
    <h3 class="text-lg font-semibold p-4 border-b border-gray-700 bg-gray-900 flex-shrink-0">Adapted Script (Editable)</h3>
    <textarea id="adaptedScriptEditor" class="editor-panel w-full h-full bg-black p-4 text-white font-mono text-sm leading-relaxed resize-none" placeholder="AI-generated adaptation will appear here. You can edit this text at any time."></textarea>
</div>

<script>
  // DOM Elements
  const setupView = document.getElementById('setup-view');
  const editorView = document.getElementById('editor-view');
  const apiSelectionRadios = document.querySelectorAll('input[name="apiSelection"]');
  const geminiForm = document.getElementById('gemini-form');
  const localForm = document.getElementById('local-form');
  const fileInput = document.getElementById('fileInput');
  const fileStatus = document.getElementById('fileStatus');
  const viewScriptButton = document.getElementById('viewScriptButton');
  const continueButton = document.getElementById('continueButton');
  const continueText = document.getElementById('continueText');
  const continueLoader = document.getElementById('continueLoader');
  const originalScriptViewer = document.getElementById('originalScriptViewer');
  const adaptedScriptEditor = document.getElementById('adaptedScriptEditor');
  const appStatus = document.getElementById('appStatus');
  const downloadButton = document.getElementById('downloadButton');
  const resetButton = document.getElementById('resetButton');
  const storyMemory = document.getElementById('storyMemory');
  const beatSheetInput = document.getElementById('beatSheetInput');
  const testLocalApiButton = document.getElementById('testLocalApiButton');
  const apiTestStatus = document.getElementById('apiTestStatus');

  // State Variables
  let originalScriptContent = '';
  let currentChunkIndex = 0;
  let chunkBoundaries = [];
  let storyMemoryData = '';

  // Constants
  const DEFAULT_CHUNK_SIZE = 7000;

  // Event listeners
  apiSelectionRadios.forEach(radio => radio.addEventListener('change', toggleApiForm));
  fileInput.addEventListener('change', handleFileUpload);
  viewScriptButton.addEventListener('click', showEditorView);
  continueButton.addEventListener('click', generateNextPart);
  resetButton.addEventListener('click', () => location.reload());
  downloadButton.addEventListener('click', downloadScript);
  [originalScriptViewer, adaptedScriptEditor].forEach(el => el.addEventListener('scroll', syncScroll));
  testLocalApiButton.addEventListener('click', testLocalApiConnection);

  function toggleApiForm(event) {
    if (event.target.value === 'gemini') {
      geminiForm.classList.remove('hidden');
      localForm.classList.add('hidden');
      apiTestStatus.textContent = '';
    } else {
      geminiForm.classList.add('hidden');
      localForm.classList.remove('hidden');
      apiTestStatus.textContent = '';
    }
  }

  async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    viewScriptButton.disabled = true;
    fileStatus.textContent = `Parsing "${file.name}"...`;
    fileStatus.classList.remove('text-green-500', 'text-red-500');

    try {
      const extension = file.name.split('.').pop().toLowerCase();
      let textContent = '';
      if (extension === 'pdf') textContent = await parsePdf(file);
      else if (extension === 'docx') textContent = await parseDocx(file);
      else if (['fountain', 'txt'].includes(extension)) textContent = await file.text();
      else throw new Error('Unsupported file type.');

      originalScriptContent = textContent.trim();
      fileStatus.textContent = `✅ Loaded: ${file.name} (Length: ${originalScriptContent.length} chars)`;
      fileStatus.classList.add('text-green-500');

      createChunkBoundaries();
      viewScriptButton.disabled = false;
    } catch (error) {
      fileStatus.textContent = `Error: ${error.message}`;
      fileStatus.classList.add('text-red-500');
    }
  }

  function createChunkBoundaries() {
    const beatsRaw = beatSheetInput.value.trim();
    chunkBoundaries = [];

    if (beatsRaw) {
      const beats = beatsRaw.split('\n').map(b => b.trim()).filter(Boolean);
      const approxChunkSize = Math.floor(originalScriptContent.length / beats.length);
      let start = 0;
      beats.forEach((beat, idx) => {
        let end = (idx < beats.length - 1) ? start + approxChunkSize : originalScriptContent.length;
        chunkBoundaries.push({ start, end });
        start = end;
      });
    } else {
      const length = originalScriptContent.length;
      let start = 0;
      while (start < length) {
        let end = Math.min(start + DEFAULT_CHUNK_SIZE, length);
        chunkBoundaries.push({ start, end });
        start = end;
      }
    }
  }

  function showEditorView() {
    if (!originalScriptContent) return;
    originalScriptViewer.value = originalScriptContent;
    setupView.classList.add('hidden');
    editorView.classList.remove('hidden');
    updateStatus('Ready. Enter parameters and generate the first part.', 'green');
  }

  async function generateNextPart() {
    if (currentChunkIndex >= chunkBoundaries.length) {
      updateStatus('Adaptation complete!', 'green');
      setContinueButtonLoading(false, true);
      return;
    }
    setContinueButtonLoading(true);

    const { start, end } = chunkBoundaries[currentChunkIndex];
    const scriptChunk = originalScriptContent.substring(start, end).trim();
    const progress = Math.round(((currentChunkIndex + 1) / chunkBoundaries.length) * 100);
    updateStatus(`Adapting chunk ${currentChunkIndex + 1} of ${chunkBoundaries.length}... (${progress}%)`, 'yellow');

    storyMemoryData = generateStoryMemorySummary(adaptedScriptEditor.value);

    const systemPrompt = `You are a world-class screenplay adapter AI specialized in feature film scripts. Adapt the screenplay chunk provided, respecting the target language, culture, and core instructions. Maintain character names, plot points, and tone as defined in prior adapted material. Use the Story Memory to maintain continuity:\n${storyMemoryData}`;

    let userPrompt = `Parameters:\n- Target Language: ${document.getElementById('targetLanguage').value || 'as in original'}\n- Target Culture/Nation: ${document.getElementById('targetCulture').value || 'as in original'}\n- Core Instructions: ${document.getElementById('manualChanges').value || 'None'}\n\n---\nOriginal Screenplay Chunk:\n"""${scriptChunk}"""\n\nPlease provide ONLY the adapted version of THIS CHUNK without introductory phrases.`;

    if (adaptedScriptEditor.value.length > 500) {
      const recentContext = adaptedScriptEditor.value.slice(-500);
      userPrompt = `Previous Adapted Context:\n"""${recentContext}"""\n\n` + userPrompt;
    }

    try {
      const adaptedText = await callApi(systemPrompt, userPrompt);
      adaptedScriptEditor.value += (adaptedScriptEditor.value.length > 0 ? '\n\n' : '') + adaptedText;
      adaptedScriptEditor.scrollTop = adaptedScriptEditor.scrollHeight;
      storyMemory.value = storyMemoryData;
      currentChunkIndex++;
      const finished = currentChunkIndex >= chunkBoundaries.length;
      updateStatus(finished ? 'Adaptation complete!' : `Chunk ${currentChunkIndex} complete. Ready for next.`, 'green');
      setContinueButtonLoading(false, finished);
    } catch (error) {
      updateStatus(`Error: ${error.message}`, 'red');
      setContinueButtonLoading(false);
    }
  }

  function generateStoryMemorySummary(adaptedScript) {
    const characterMatches = adaptedScript.match(/\b[A-Z]{2,}\b/g) || [];
    const uniqueCharacters = [...new Set(characterMatches)].join(', ') || 'No characters identified';
    return `Known Characters: ${uniqueCharacters}\nPlot Points: (to be expanded by user)\nThemes: (to be expanded by user)`;
  }

  async function callApi(systemPrompt, userPrompt) {
    const selectedApi = document.querySelector('input[name="apiSelection"]:checked').value;

    if (selectedApi === 'gemini') {
      const apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) throw new Error('Gemini API Key is missing.');

      const MAX_OUTPUT = 4096;

      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const payload = {
        contents: [{ parts: [{ text: userPrompt }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        generationConfig: { temperature: 0.7, maxOutputTokens: MAX_OUTPUT }
      };

      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(`API Error: ${err.error?.message || response.statusText}`);
      }

      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';

    } else {
      let baseUrl = document.getElementById('apiUrl').value.trim();
      if (!baseUrl) throw new Error('Local Server URL is missing.');

      // API expects /v1/chat/completions path appended internally
      const url = `${baseUrl.replace(/\/$/, '')}/v1/chat/completions`;

      const payload = {
        model: "local-model",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ],
        temperature: 0.7,
        max_tokens: 2048,
        stream: false
      };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errJson = await response.json().catch(() => ({}));
          throw new Error(`API Error: ${errJson.error?.message || response.statusText}`);
        }

        const result = await response.json();
        if (!result.choices || !result.choices[0].message || !result.choices[0].message.content) {
          throw new Error('Unexpected local API response structure');
        }
        return result.choices[0].message.content.trim();

      } catch (err) {
        console.error('Local API error:', err);
        throw new Error(`Local API request failed: ${err.message}`);
      }
    }
  }

  // UI Helpers
  function setContinueButtonLoading(isLoading, finished = false) {
    continueButton.disabled = isLoading || finished;
    if (finished) {
      continueText.textContent = 'Finished';
      continueButton.classList.replace('bg-blue-600', 'bg-gray-500');
    } else if (isLoading) {
      continueText.classList.add('hidden');
      continueLoader.classList.remove('hidden');
    } else {
      continueText.textContent = 'Generate Next Part';
      continueText.classList.remove('hidden');
      continueLoader.classList.add('hidden');
    }
  }

  function updateStatus(message, color) {
    const colorClass = { green: 'text-green-400', yellow: 'text-yellow-400', red: 'text-red-400' };
    appStatus.textContent = message;
    appStatus.className = `text-sm text-center my-4 h-8 ${colorClass[color] || 'text-gray-400'}`;
  }

  function downloadScript() {
    const text = adaptedScriptEditor.value;
    if (!text || text.trim() === '') {
      alert('No adapted script to download.');
      return;
    }
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'adapted_screenplay.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  let scrollTimeout;
  function syncScroll(event) {
    clearTimeout(scrollTimeout);
    const sourceElement = event.target;
    const targetElement = sourceElement.id === 'originalScriptViewer' ? adaptedScriptEditor : originalScriptViewer;

    const scrollPercentage = sourceElement.scrollTop / (sourceElement.scrollHeight - sourceElement.clientHeight);
    targetElement.scrollTop = scrollPercentage * (targetElement.scrollHeight - targetElement.clientHeight);

    targetElement.removeEventListener('scroll', syncScroll);
    scrollTimeout = setTimeout(() => targetElement.addEventListener('scroll', syncScroll), 100);
  }

  // Parsing Helpers
  async function parsePdf(file) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    let text = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(item => item.str).join(' ') + '\n';
    }
    return text;
  }

  async function parseDocx(file) {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    return result.value;
  }

  async function testLocalApiConnection() {
    apiTestStatus.textContent = '';
    if (document.querySelector('input[name="apiSelection"]:checked').value !== 'local') {
      apiTestStatus.textContent = 'Switch to Local Server option to test local API.';
      apiTestStatus.className = 'text-xs mt-2 text-center text-red-500';
      return;
    }

    const baseUrl = document.getElementById('apiUrl').value.trim();
    if (!baseUrl) {
      apiTestStatus.textContent = 'Local Server URL is empty.';
      apiTestStatus.className = 'text-xs mt-2 text-center text-red-500';
      return;
    }

    apiTestStatus.textContent = 'Testing connection...';
    apiTestStatus.className = 'text-xs mt-2 text-center text-yellow-400';

    // Test payload similar to the production call with minimal tokens and a ping message
    const testPayload = {
      model: "local-model",
      messages: [
        { role: "system", content: "Connectivity test." },
        { role: "user", content: "Ping" }
      ],
      temperature: 0,
      max_tokens: 5,
      stream: false
    };

    try {
      const response = await fetch(`${baseUrl.replace(/\/$/, '')}/v1/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(testPayload)
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        apiTestStatus.textContent = `Error: ${err.error?.message || response.statusText}`;
        apiTestStatus.className = 'text-xs mt-2 text-center text-red-500';
        return;
      }

      const data = await response.json();

      if (data.choices && data.choices[0]?.message?.content) {
        apiTestStatus.textContent = 'Local API connection successful!';
        apiTestStatus.className = 'text-xs mt-2 text-center text-green-500';
      } else {
        apiTestStatus.textContent = 'Unexpected response format from local API.';
        apiTestStatus.className = 'text-xs mt-2 text-center text-red-500';
      }
    } catch (error) {
      apiTestStatus.textContent = `Connection failed: ${error.message}`;
      apiTestStatus.className = 'text-xs mt-2 text-center text-red-500';
    }
  }
 // --- START: ADD THIS NEW CODE ---
  function makePanelsResizable() {
      const resizer = document.getElementById('resizer');
      const leftPanel = document.getElementById('original-script-panel');
      const rightPanel = document.getElementById('adapted-script-panel');

      if (!resizer || !leftPanel || !rightPanel) return;

      let x = 0;
      let leftWidth = 0;
      let rightWidth = 0;

      const mouseDownHandler = function (e) {
          // Prevent text selection during drag
          e.preventDefault();

          // Get the current mouse position and panel widths
          x = e.clientX;
          leftWidth = leftPanel.getBoundingClientRect().width;
          rightWidth = rightPanel.getBoundingClientRect().width;

          // Attach the listeners to the document
          document.addEventListener('mousemove', mouseMoveHandler);
          document.addEventListener('mouseup', mouseUpHandler);

          // Add some visual feedback
          document.body.style.cursor = 'col-resize';
          document.body.style.userSelect = 'none';
      };

      const mouseMoveHandler = function (e) {
          // How far the mouse has been moved
          const dx = e.clientX - x;

          const newLeftWidth = leftWidth + dx;
          const newRightWidth = rightWidth - dx;
          
          // Set constraints to prevent panels from collapsing (e.g., min 200px)
          if (newLeftWidth > 200 && newRightWidth > 200) {
              // Use flex-basis for proper resizing in a flex container
              leftPanel.style.flexBasis = `${newLeftWidth}px`;
              rightPanel.style.flexBasis = `${newRightWidth}px`;
          }
      };

      const mouseUpHandler = function () {
          // Remove the listeners from the document
          document.removeEventListener('mousemove', mouseMoveHandler);
          document.removeEventListener('mouseup', mouseUpHandler);

          // Restore cursor and text selection
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
      };

      // Attach the handler to the resizer
      resizer.addEventListener('mousedown', mouseDownHandler);
  }

 makePanelsResizable();
  
</script>
</body>
</html>
